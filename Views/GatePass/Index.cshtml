@model IEnumerable<RMG_Shipping_Documents.Models.Gatepass>
@{
    ViewData["Title"] = "Gatepass Management";
}

<div class="section-header d-flex justify-content-between align-items-center">
    <span>Gatepass Management</span>
    <a class="btn btn-primary" asp-action="Create">Create New Gatepass</a>
</div>

<table class="table table-striped table-bordered mt-2">
    <thead class="table-dark">
        <tr>
            <th>Gate Pass No</th>
            <th>Date</th>
            <th>Company Name</th>
            <th>Issued To</th>
            <th>Truck No</th>
            <th>Driver Name</th>
            <th>Mobile No</th>
            <th>Actions</th>
        </tr>
    </thead>
    <tbody>
        @if (Model != null && Model.Any())
        {
            @foreach (var item in Model)
            {
                <tr id="row-@item.Id">
                    <td>@item.GatePassNo</td>
                    <td>@item.Date.ToString("dd/MM/yyyy")</td>
                    <td>@item.CompanyName</td>
                    <td>@item.IssuedTo</td>
                    <td>@item.TruckNo</td>
                    <td>@item.DriverName</td>
                    <td>@item.MobileNo</td>
                    <td>
                        <div class="dropdown">
                            <button class="btn btn-sm btn-light dropdown-toggle" type="button" data-bs-toggle="dropdown">☰</button>
                            <ul class="dropdown-menu">
                                <li><a class="dropdown-item" href="#" onclick="viewDetails(@item.Id)">View</a></li>
                                <li><a class="dropdown-item" asp-action="Edit" asp-route-id="@item.Id">Edit</a></li>
                                <li><a class="dropdown-item" href="#" onclick="confirmDelete(@item.Id, '@item.GatePassNo')">Delete</a></li>
                            </ul>
                        </div>
                    </td>
                </tr>
            }
        }
        else
        {
            <tr>
                <td colspan="8" class="text-center">No gatepasses found.</td>
            </tr>
        }
    </tbody>
</table>

<!-- Details Modal -->
<div class="modal fade" id="detailsModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-info text-white">
                <h5 class="modal-title">Gatepass Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body text-center">
                <img id="detailQrCode" width="100" height="100" />
                <p id="detailGatePassNo" class="mt-2 fw-bold"></p>
                <p id="detailDate"></p>
                <p id="detailCompanyName"></p>
                <p id="detailIssuedTo"></p>
            </div>
        </div>
    </div>
</div>

<!-- Delete Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title">Confirm Delete</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                Are you sure you want to delete Gatepass <strong id="gatepassNoToDelete"></strong>?
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" id="confirmDeleteBtn">Delete</button>
            </div>
        </div>
    </div>
</div>

<form asp-antiforgery="true">
    
</form>

@section Scripts {
    <script>
        let currentGatepassId = null;

        function viewDetails(id) {
            fetch(`/Gatepass/GetDetails/${id}`)
                .then(res => res.json())
                .then(data => {
                    if (data.success) {
                        const gp = data.gatepass;

                        // Show QR code
                        document.getElementById('detailQrCode').src = gp.qrCode;

                        document.getElementById('detailGatePassNo').innerText = "Gatepass No: " + gp.gatePassNo;
                        document.getElementById('detailDate').innerText = "Date: " + new Date(gp.date).toLocaleDateString();
                        document.getElementById('detailCompanyName').innerText = "Company: " + gp.companyName;
                        document.getElementById('detailIssuedTo').innerText = "Issued To: " + gp.issuedTo;

                        new bootstrap.Modal(document.getElementById('detailsModal')).show();
                    } else {
                        alert("Failed to load details.");
                    }
                });
        }

        function confirmDelete(id, gpNo) {
            currentGatepassId = id;
            document.getElementById('gatepassNoToDelete').innerText = gpNo;
            new bootstrap.Modal(document.getElementById('deleteModal')).show();
        }




         document.addEventListener('DOMContentLoaded', function () {
            document.getElementById('confirmDeleteBtn').addEventListener('click', function () {
                if (!currentGatepassId) return;

                const token = document.querySelector('input[name="__RequestVerificationToken"]').value;
                const formData = new FormData();
                formData.append("__RequestVerificationToken", token);

                fetch(`/Gatepass/Delete/${currentGatepassId}`, {
                    method: 'POST',
                    body: formData
                })
                .then(res => res.json())
                .then(data => {
                    if (data.success) {
                        const row = document.getElementById('row-' + currentGatepassId);
                        if (row) row.remove();

                        const deleteModal = bootstrap.Modal.getInstance(document.getElementById('deleteModal'));
                        if (deleteModal) deleteModal.hide();
                    } else {
                        alert(data.message || 'Delete failed');
                    }
                })
                .catch(err => {
                    console.error(err);
                    alert('Error deleting gatepass');
                });
            });
        });

    </script>
}
