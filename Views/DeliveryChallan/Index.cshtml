@model IEnumerable<RMG_Shipping_Documents.Models.DeliveryChallan>

@{
    ViewData["Title"] = "Delivery Challan Management";
}

<style>
    .section-header {
        background-color: #17a2b8;
        color: white;
        padding: 8px 12px;
        font-weight: bold;
        margin-top: 20px;
    }

    .table {
        width: 100%;
        margin-bottom: 1rem;
        color: #212529;
        border-collapse: collapse;
    }

        .table th, .table td {
            padding: 0.75rem;
            vertical-align: top;
            border-top: 1px solid #dee2e6;
        }

        .table thead th {
            vertical-align: bottom;
            border-bottom: 2px solid #dee2e6;
            border-top: none;
        }

    .table-striped tbody tr:nth-of-type(odd) {
        background-color: rgba(0,0,0,.05);
    }

    .table-bordered {
        border: 1px solid #dee2e6;
    }

        .table-bordered th, .table-bordered td {
            border: 1px solid #dee2e6;
        }

    .table-dark {
        color: #fff;
        background-color: #343a40;
    }

        .table-dark th, .table-dark td {
            border-color: #454d55;
        }

    .btn {
        display: inline-block;
        font-weight: 400;
        text-align: center;
        white-space: nowrap;
        vertical-align: middle;
        user-select: none;
        border: 1px solid transparent;
        padding: 0.375rem 0.75rem;
        font-size: 1rem;
        line-height: 1.5;
        border-radius: 0.25rem;
        transition: color .15s ease-in-out,background-color .15s ease-in-out,border-color .15s ease-in-out,box-shadow .15s ease-in-out;
    }

    .btn-primary {
        color: #fff;
        background-color: #007bff;
        border-color: #007bff;
    }

    .btn-info {
        color: #fff;
        background-color: #17a2b8;
        border-color: #17a2b8;
    }

    .btn-danger {
        color: #fff;
        background-color: #dc3545;
        border-color: #dc3545;
    }

    .btn-secondary {
        color: #fff;
        background-color: #6c757d;
        border-color: #6c757d;
    }

    .btn-sm {
        padding: 0.25rem 0.5rem;
        font-size: 0.875rem;
        line-height: 1.5;
        border-radius: 0.2rem;
    }

    .d-flex {
        display: flex !important;
    }

    .justify-content-between {
        justify-content: space-between !important;
    }

    .align-items-center {
        align-items: center !important;
    }

    .mt-2 {
        margin-top: 0.5rem !important;
    }

    .text-center {
        text-align: center !important;
    }

    .delete-btn {
        cursor: pointer;
    }

    /* Modal Styles */
    .modal {
        position: fixed;
        top: 0;
        left: 0;
        z-index: 1055;
        display: none;
        width: 100%;
        height: 100%;
        overflow-x: hidden;
        overflow-y: auto;
        outline: 0;
    }

    .modal-dialog {
        position: relative;
        width: auto;
        max-width: 500px;
        margin: 1.75rem auto;
        pointer-events: none;
    }

    .modal.fade .modal-dialog {
        transition: transform .3s ease-out;
        transform: translate(0,-50px);
    }

    .modal.show .modal-dialog {
        transform: none;
    }

    .modal-content {
        position: relative;
        display: flex;
        flex-direction: column;
        width: 100%;
        pointer-events: auto;
        background-color: #fff;
        background-clip: padding-box;
        border: 1px solid rgba(0,0,0,.2);
        border-radius: 0.3rem;
        outline: 0;
    }

    .modal-backdrop {
        position: fixed;
        top: 0;
        left: 0;
        z-index: 1050;
        width: 100vw;
        height: 100vh;
        background-color: #000;
    }

        .modal-backdrop.fade {
            opacity: 0;
        }

        .modal-backdrop.show {
            opacity: .5;
        }

    .modal-header {
        display: flex;
        flex-shrink: 0;
        align-items: center;
        justify-content: space-between;
        padding: 1rem 1rem;
        border-bottom: 1px solid #dee2e6;
        border-top-left-radius: calc(0.3rem - 1px);
        border-top-right-radius: calc(0.3rem - 1px);
    }

    .modal-title {
        margin-bottom: 0;
        line-height: 1.5;
    }

    .modal-body {
        position: relative;
        flex: 1 1 auto;
        padding: 1rem;
    }

    .modal-footer {
        display: flex;
        flex-wrap: wrap;
        flex-shrink: 0;
        align-items: center;
        justify-content: flex-end;
        padding: 0.75rem;
        border-top: 1px solid #dee2e6;
        border-bottom-right-radius: calc(0.3rem - 1px);
        border-bottom-left-radius: calc(0.3rem - 1px);
    }

    .btn-close {
        box-sizing: content-box;
        width: 1em;
        height: 1em;
        padding: 0.25em 0.25em;
        color: #000;
        background: transparent url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16' fill='%23000'%3e%3cpath d='m.235.867 8.832 8.832-8.832 8.832a.5.5 0 0 0 .707.707L9.774 10.4l8.832 8.832a.5.5 0 0 0 .707-.707L10.481 9.774l8.832-8.832a.5.5 0 0 0-.707-.707L9.774 9.067.942.235a.5.5 0 0 0-.707.632z'/%3e%3c/svg%3e") center/1em auto no-repeat;
        border: 0;
        border-radius: 0.25rem;
        opacity: .5;
    }

        .btn-close:hover {
            color: #000;
            text-decoration: none;
            opacity: .75;
        }

    .alert {
        position: relative;
        padding: 0.75rem 1.25rem;
        margin-bottom: 1rem;
        border: 1px solid transparent;
        border-radius: 0.25rem;
    }

    .alert-success {
        color: #0f5132;
        background-color: #d1e7dd;
        border-color: #badbcc;
    }

    .alert-danger {
        color: #842029;
        background-color: #f8d7da;
        border-color: #f5c2c7;
    }

    .position-fixed {
        position: fixed !important;
    }

    .alert-dismissible {
        padding-right: 3rem;
    }

        .alert-dismissible .btn-close {
            position: absolute;
            top: 0;
            right: 0;
            z-index: 2;
            padding: 0.75rem 1.25rem;
        }
</style>

<div class="section-header-yellow d-flex justify-content-between align-items-center" style="margin-bottom:10px">
    <h3>Delivery Challan Management</h3>
    <a class="btn btn-primary" asp-action="Create">Create New Delivery Challan</a>
</div>

<div class="mt-2">
    <table class="table table-striped table-bordered">
        <thead class="table-dark">
            <tr>
                <th>Challan No</th>
                <th>Date</th>
                <th>Truck No</th>
                <th>Recipient</th>
                <th>Status</th>
                <th>In Date</th>
                <th>Out Date</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            @if (Model != null && Model.Any())
            {
                @foreach (var item in Model)
                {
                    <tr>
                        <td>@item.ChallanNo</td>
                        <td>@item.Date.ToString("dd/MM/yyyy")</td>
                        <td>@item.TruckNo</td>
                        <td>@item.Recipient</td>
                        <td>
                            @switch (item.Status)
                            {
                                case "Pending":
                                    <span class="badge bg-warning text-dark">@item.Status</span>
                                    break;
                                case "In Progress":
                                    <span class="badge bg-primary">@item.Status</span>
                                    break;
                                case "Completed":
                                    <span class="badge bg-success">@item.Status</span>
                                    break;
                                case "Cancelled":
                                    <span class="badge bg-danger">@item.Status</span>
                                    break;
                                default:
                                    <span class="badge bg-secondary">@item.Status</span>
                                    break;
                            }
                        </td>
                        <td>
                            @if (item.InDate.HasValue)
                            {
                                @item.InDate.Value.ToString("dd/MM/yyyy HH:mm")
                            }
                            else
                            {
                                <span>-</span>
                            }
                        </td>
                        <td>
                            @if (item.OutDate.HasValue)
                            {
                                @item.OutDate.Value.ToString("dd/MM/yyyy HH:mm")
                            }
                            else
                            {
                                <span>-</span>
                            }
                        </td>
                        <td class="text-center">
                            <a class="btn btn-sm btn-primary" asp-action="Edit" asp-route-id="@item.Id">Edit</a>
                            <button type="button" class="btn btn-sm btn-danger delete-btn"
                                    data-id="@item.Id"
                                    data-challan-no="@item.ChallanNo">
                                Delete
                            </button>
                        </td>
                    </tr>
                }
            }
            else
            {
                <tr>
                    <td colspan="8" class="text-center">No delivery challans found.</td>
                </tr>
            }
        </tbody>
    </table>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1" aria-labelledby="deleteModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deleteModalLabel">Confirm Delete</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                Are you sure you want to delete delivery challan <strong id="challanNoToDelete"></strong>?
                <div id="deleteError" class="alert alert-danger mt-3" style="display: none;"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" id="cancelDelete">Cancel</button>
                <button type="button" class="btn btn-danger" id="confirmDelete">Delete</button>
            </div>
        </div>
    </div>
</div>

<!-- Add anti-forgery token for AJAX requests -->
<form asp-antiforgery="true"></form>

@section Scripts {
    <script>
        let deleteModal;
        let currentDeleteId = null;

        // Initialize modal
        document.addEventListener('DOMContentLoaded', function() {
            deleteModal = {
                show: function() {
                    const modal = document.getElementById('deleteModal');
                    modal.style.display = 'block';
                    modal.classList.add('show');
                    document.body.classList.add('modal-open');

                    // Create backdrop
                    let backdrop = document.createElement('div');
                    backdrop.className = 'modal-backdrop fade show';
                    backdrop.id = 'modalBackdrop';
                    document.body.appendChild(backdrop);

                    // Prevent body scroll
                    document.body.style.overflow = 'hidden';
                },
                hide: function() {
                    const modal = document.getElementById('deleteModal');
                    modal.style.display = 'none';
                    modal.classList.remove('show');
                    document.body.classList.remove('modal-open');

                    // Remove backdrop
                    let backdrop = document.getElementById('modalBackdrop');
                    if (backdrop) {
                        backdrop.remove();
                    }

                    // Restore body scroll
                    document.body.style.overflow = '';
                }
            };
        });

        // Handle delete button clicks
        document.querySelectorAll('.delete-btn').forEach(button => {
            button.addEventListener('click', function() {
                const id = this.getAttribute('data-id');
                const challanNo = this.getAttribute('data-challan-no');

                currentDeleteId = id;
                document.getElementById('challanNoToDelete').textContent = challanNo;
                document.getElementById('deleteError').style.display = 'none';

                deleteModal.show();
            });
        });

        // Handle cancel button
        document.getElementById('cancelDelete').addEventListener('click', function() {
            deleteModal.hide();
        });

        // Handle close button
        document.querySelector('.btn-close').addEventListener('click', function() {
            deleteModal.hide();
        });

        // Handle confirm delete
        document.getElementById('confirmDelete').addEventListener('click', function() {
            if (!currentDeleteId) return;

            // Get anti-forgery token
            const token = document.querySelector('input[name="__RequestVerificationToken"]').value;

            // Disable buttons during request
            document.getElementById('confirmDelete').disabled = true;
            document.getElementById('cancelDelete').disabled = true;

            // Create form data
            const formData = new FormData();
            formData.append('__RequestVerificationToken', token);

            // Send delete request - FIXED URL to match your controller
            fetch(`/DeliveryChallan/Delete/${currentDeleteId}`, {
                method: 'POST',
                body: formData
            })
            .then(response => {
                if (response.ok) {
                    // Show success message
                    showNotification('Delivery challan deleted successfully!', 'success');

                    // Remove the row from table
                    const row = document.querySelector(`button[data-id="${currentDeleteId}"]`).closest('tr');
                    row.remove();

                    // Hide modal
                    deleteModal.hide();

                    // Check if table is empty
                    const tbody = document.querySelector('tbody');
                    if (tbody.children.length === 0) {
                        tbody.innerHTML = '<tr><td colspan="8" class="text-center">No delivery challans found.</td></tr>';
                    }
                } else {
                    throw new Error('Delete failed');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                document.getElementById('deleteError').textContent = 'Error deleting delivery challan. Please try again.';
                document.getElementById('deleteError').style.display = 'block';
            })
            .finally(() => {
                // Re-enable buttons
                document.getElementById('confirmDelete').disabled = false;
                document.getElementById('cancelDelete').disabled = false;
            });
        });

        // Show notification function
        function showNotification(message, type) {
            const notification = document.createElement('div');
            notification.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
            notification.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
            notification.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            `;
            document.body.appendChild(notification);

            // Auto remove after 3 seconds
            setTimeout(() => {
                notification.remove();
            }, 3000);
        }

        // Close modal when clicking on backdrop
        document.addEventListener('click', function(e) {
            if (e.target.classList.contains('modal-backdrop')) {
                deleteModal.hide();
            }
        });

        // Close modal with Escape key
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape' && document.getElementById('deleteModal').classList.contains('show')) {
                deleteModal.hide();
            }
        });
    </script>
}